SELECT 
    CR.*,
    HM.NEXT_STATUS,
    CR.NEXT_USER_ID,
    CASE 
        WHEN CR.NEXT_STATUS != 'Closed' 
             THEN DATEDIFF(day, CR.STATUS_DATE, GETDATE()) 
        ELSE NULL 
    END AS PendingDays,
    DATEDIFF(day, CR.CREATED_ON, GETDATE()) AS Created_vs_Current,
    FD.USERNAME
FROM App_COMPLAINT_HELP_REGISTER CR
LEFT JOIN App_HELPDESK_STATUS_MASTER HM 
    ON CR.COMPLAINT_STATUS = HM.STATUS_CODE
OUTER APPLY
(
    SELECT TOP 1 D.*, FL.USERNAME
    FROM App_COMPLAINT_HELP_DETAILS D
    INNER JOIN App_HELPDESK_FWD_LIST FL 
        ON D.UserID = FL.USERID
    WHERE D.MasterID = CR.ID   -- Assuming CR.ID is the PK of master
    ORDER BY D.CreatedOn DESC  -- Get only the latest detail row
) FD
WHERE CR.STATUS_CODE = 'S0007'
ORDER BY CR.COMPLAINT_DATE DESC;
